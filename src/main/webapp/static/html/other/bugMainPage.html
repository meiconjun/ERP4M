<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 告诉浏览器该页面是自适应布局 -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="../../../static/plugins/adminLTE/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../../../static/plugins/adminLTE/bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="../../../static/plugins/adminLTE/bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../../../static/plugins/adminLTE/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="../../../static/plugins/layui/css/layui.css">
    <!-- 自定义样式表 -->
    <link rel="stylesheet" href="../../../static/css/main.css">
    <!-- 富文本插件 -->
    <script src="../../../static/plugins/tinymce/tinymce.js"></script>

    <!-- Google Font -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body>
<div >
    <!-- Box Comment -->
    <div class="box box-widget">
        <div class="box-header with-border">
            <div class="user-block">
                <img id="bugMainPage_header" class="img-circle" src="../../../mediaFile/image/user3-128x128.jpg" alt="用户图像">
                <span class="username" id="bugMainPage_username"><a href="#">Jonathan Burke Jr.</a></span>
                <span class="description" id="bugMainPage_lastModiTime">最后修改于 - </span>
                <span class="description" ><span id="bugMainPage_severity">严重级别 - 中等 |</span><span id="bugMainPage_priority"> 优先级 - 低 |</span><span id="bugMainPage_status"> 状态 - 未解决</span></span>
            </div>
            <!-- /.user-block -->

            <!-- /.box-tools -->
        </div>
        <!-- /.box-header -->
        <div class="box-body">

            <div  id="bugMainPage_content"></div>
            <textarea  hidden="hidden" id="bugMainPage_editDiv"></textarea>
            <!--<button type="button" class="btn btn-default btn-xs"><i class="fa fa-share"></i> 分享</button>
            <button type="button" class="btn btn-default btn-xs"><i class="fa fa-thumbs-o-up"></i> 喜欢</button>
            <button type="button" class="btn btn-default btn-xs"><i class="fa fa-thumbs-o-up"></i> 喜欢</button>-->
            <span class="pull-right text-muted" id="bugMainPage_commentCount">3 评论</span>
        </div>
        <!-- /.box-body -->
        <div class="box-footer box-comments" id="bugMainPage_commentContent">
            <div class="box-comment">
                <!-- User image -->
                <img class="img-circle img-sm" src="../../../mediaFile/image/user3-128x128.jpg" alt="用户图像">

                <div class="comment-text">
                      <span class="username">
                        Maria Gonzales
                        <span class="text-muted pull-right">今天下午 8:03</span>
                      </span>
                    一个长期以来的事实是，
                    通过查看其布局页面内容时读者会分心。
                </div>
                <!-- /.comment-text -->
            </div>
            <!-- /.box-comment -->
            <div class="box-comment">
                <!-- User image -->
                <img class="img-circle img-sm" src="../../../mediaFile/image/user3-128x128.jpg" alt="用户图像">

                <div class="comment-text">
                      <span class="username">
                        Luna Stark
                        <span class="text-muted pull-right">今天下午 8:03</span>
                      </span><!-- /.username -->
                    一个长期以来的事实是，
                    通过查看其布局页面内容时读者会分心。
                </div>
                <!-- /.comment-text -->
            </div>
            <!-- /.box-comment -->
        </div>
        <div id="bugMainPage_commentPage" style="text-align:center;"></div>
        <div style="text-align: right;margin-right: 10px;">
            <button class="layui-btn layui-btn-sm layui-btn-normal" type="button" id="bugMainPage_submit" >提交评论</button>
        </div>
        <!-- /.box-footer -->
        <div class="box-footer">
            <div>
                <img id="bugMainPage_userHeader" class="img-responsive img-circle img-sm" src="../../../mediaFile/image/user3-128x128.jpg" alt="Alt 文本">
                <!-- .img-push is used to add margin to elements next to floating images -->
                <div class="img-push">
                    <!--<input type="text" class="form-control input-sm" placeholder="发表评论">-->
                    <textarea id="bugMainPage_commentTextArea"></textarea>
                </div>
            </div>
        </div>
        <!-- /.box-footer -->
    </div>
    <!-- /.box -->
</div>
<script src="../../../static/plugins/adminLTE/bower_components/jquery/dist/jquery.min.js"></script>
<script src="../../../static/js/common/commonUtil.js"></script>
<script src="../../../static/js/common/contants.js"></script>
<!-- layui插件-->
<script src="../../../static/plugins/layui/layui.all.js"></script>
<script src="../../../static/js/support/jsPlugin.js"></script>
<script src="../../../static/js/common/commonField.js"></script>
<script type="text/javascript">

    tinymce.init({
        selector:  "#bugMainPage_commentTextArea",
        language:'zh_CN',
        // height: 900, //编辑器高度
        min_height: 300,
        placeholder: '发表评论',
        plugins: 'print preview searchreplace autolink directionality visualblocks visualchars fullscreen image link media template code codesample table charmap hr pagebreak nonbreaking anchor insertdatetime advlist lists wordcount imagetools textpattern help emoticons autosave autoresize',
        toolbar: 'undo redo restoredraft | cut copy paste pastetext | forecolor backcolor bold italic underline strikethrough link | alignleft aligncenter alignright alignjustify outdent indent | \
                     styleselect formatselect fontselect fontsizeselect | bullist numlist | blockquote subscript superscript removeformat | \
                     table image media charmap emoticons hr insertdatetime print preview | bdmap indent2em lineheight formatpainter axupimgs',
        file_picker_callback: function (callback, value, meta) {// 文件上传回调,点击文件上传图标时触发
            //文件分类
            let file_type='.pdf, .txt, .zip, .rar, .7z, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .mp3, .mp4, .png, .jpg, .jpeg, .gif';
            //后端接收上传文件的地址
            let up_url='../../../bugListFileUpload.do';
            //模拟出一个input用于添加本地文件
            let input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', file_type);
            input.click();
            input.onchange = function() {
                let file = this.files[0];

                let xhr, formData;
                console.log(file.name);
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', up_url);
                xhr.onload = function () {
                    let json;
                    if (xhr.status != 200) {
                        commonError('上传失败 HTTP Error: ' + xhr.status);
                        return;
                    }
                    json = JSON.parse(xhr.responseText);
                    if (!json || typeof json.location != 'string') {
                        commonError('上传失败 Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    callback(json.location);
                };
                formData = new FormData();
                formData.append('file', file, file.name);
                xhr.send(formData);
            }
        },
        file_picker_types: 'file image media',
        setup: function(editor){
            editor.on('change',function(){ editor.save(); });
        },
        init_instance_callback : function(editor) {
            window.editor1 = editor;//存到当前iframe中
        },
        extended_valid_elements: "div[name|serialNo|replyUser]"
    });
    tinymce.init({
        selector:  "#bugMainPage_editDiv",
        language:'zh_CN',
        // height: 900, //编辑器高度
        min_height: 600,
        placeholder: '发表评论',
        plugins: 'print preview searchreplace autolink directionality visualblocks visualchars fullscreen image link media template code codesample table charmap hr pagebreak nonbreaking anchor insertdatetime advlist lists wordcount imagetools textpattern help emoticons autosave autoresize',
        toolbar: 'undo redo restoredraft | cut copy paste pastetext | forecolor backcolor bold italic underline strikethrough link | alignleft aligncenter alignright alignjustify outdent indent | \
                     styleselect formatselect fontselect fontsizeselect | bullist numlist | blockquote subscript superscript removeformat | \
                     table image media charmap emoticons hr insertdatetime print preview | bdmap indent2em lineheight formatpainter axupimgs',
        file_picker_callback: function (callback, value, meta) {// 文件上传回调,点击文件上传图标时触发
            //文件分类
            let file_type='.pdf, .txt, .zip, .rar, .7z, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .mp3, .mp4, .png, .jpg, .jpeg, .gif';
            //后端接收上传文件的地址
            let up_url='../../../bugListFileUpload.do';
            //模拟出一个input用于添加本地文件
            let input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', file_type);
            input.click();
            input.onchange = function() {
                let file = this.files[0];

                let xhr, formData;
                console.log(file.name);
                xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', up_url);
                xhr.onload = function () {
                    let json;
                    if (xhr.status != 200) {
                        commonError('上传失败 HTTP Error: ' + xhr.status);
                        return;
                    }
                    json = JSON.parse(xhr.responseText);
                    if (!json || typeof json.location != 'string') {
                        commonError('上传失败 Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    callback(json.location);
                };
                formData = new FormData();
                formData.append('file', file, file.name);
                xhr.send(formData);
            }
        },
        file_picker_types: 'file image media',
        setup: function(editor){
            editor.on('change',function(){ editor.save(); });
        },
        init_instance_callback : function(editor) {
            window.editor2 = editor;//存到当前iframe中
            editor.hide();
        }
    });

    function addCommentUserAndMark(serial_no, reply_user) {
        sessionStorage.setItem("buglist_about_serialNo", serial_no);
        sessionStorage.setItem("buglist_about_replyUser", reply_user);
        window.editor1.setContent('<div name="aboutDiv" serialNo="' + serial_no + '" replyUser="' + reply_user + '"><strong>' + '@' + commonFormatUserNo(reply_user, true) + '</strong></div><br>' +
            window.editor1.getContent()
        );
        console.log(document.body.children[0]);
        document.body.children[0].scrollIntoView(false);// 滚动到最底部
    }

    /**
     * 弹框展示楼层回复
     * @param serial_no
     */
    function getCommentUserHistory(serial_no) {
        let retData = commonAjax("../../../buglist.do", JSON.stringify({
            "beanList": [],
            "operType": "getFloorCommentHistory",
            "paramMap": {
                "serial_no": serial_no
            }
        }))
        if (retData.retCode == HANDLE_SUCCESS) {
            let retList = retData.retMap.list;
            if (retList.length == 0) {
                commonInfo("暂无回复");
            } else {
                layui.layer.open({
                    type: 1,// 页面层
                    area: ['500px', '500px'],// 宽高
                    title: '对话',// 标题
                    content: "<div class=\"box-comments\" name='box-comment-div'></div>",
                    success: function (layero, index) {//层弹出后的成功回调方法(当前层DOM,当前层索引)
                        let allComment = "";
                        for (let i = 0; i < retList.length; i++) {
                            allComment += "<div class=\"box-comment\" id='" + retList[i].serial_no + "'>\n" +
                                "                <img class=\"img-circle img-sm\" src=\"" + "data:image/jpg;base64," + retList[i].picture + "\" alt=\"用户头像\">\n" +
                                "\n" +
                                "                <div class=\"comment-text\">\n" +
                                "                      <span class=\"username\">\n" + retList[i].user_name +
                                "                        <span class=\"text-muted pull-right\">" + commonFormatDate(retList[i].reply_time) + "</span>\n" +
                                "                      </span>\n";
                            allComment += "<div>" + retList[i].content + "</div>" + /** 评论内容*/
                                /*"<div class=\"pull-right text-muted\" >" +
                                "   <a href='#' onclick='addCommentUserAndMark(\"" + commentList[i].serial_no + "\", \"" + commentList[i].reply_user + "\")'>评论</a>" +
                                "   <a href='#' onclick='getCommentUserHistory(\"" + commentList[i].serial_no + "\")'>查看对话</a>" +
                                "</div>" +*/
                                "                </div>\n" +
                                "            </div>";
                        }
                        $(layero).find("div[name='box-comment-div']").html(allComment);
                    }
                });
            }
        } else {
            commonError("获取回复失败！");
        }
    }
</script>
</body>
</html>